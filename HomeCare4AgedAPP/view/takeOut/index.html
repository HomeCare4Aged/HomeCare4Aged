<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/common/common.css" />
		<link rel="stylesheet" href="../../css/takeOut/index.css" /> 
	</head>

	<body>
		<header class="mui-bar mui-bar-nav m_orange2"> 
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">外卖</h1>
			<!--<h3 id="historyList" class="mui-icon  mui-pull-right" style="font-size: 30px; margin-top: 4%; color: white;font-weight: bold;">订单 </h3>-->
			<a id="historyList" class=" mui-icon  mui-pull-right" style="font-size: 30px;margin-left: -3%;margin-top: 15px;">订单</a>
			<div id="zz-div-address" class="mui-bar top60px " style="height: 90px;"> 
				<h5 class="black-text mui-navigate-right" id="zz-h5-address" style="font-weight: bold; font-size: 30px; float: left; margin-left: 15px; padding-top: 5%;padding-bottom: 5%;width: 85%; line-height: 30px; margin-right: 0px;">aa</h5>

			</div>
		</header>
		<div class="mui-content"> 
		    <ul class="mui-table-view " id="list_already" style="margin-top: 105px;">
				<!--<li class="mui-table-view-cell mui-media" id="list">
					<div class="marginLeftRight">
						<img class="mui-media-object mui-pull-left" src="../../images/small.png">
						<h3>李</h3>
						<label class="gray-text">2016-12-12 下午</label>
					</div>
				</li>-->
				<!--<li class="mui-table-view-cell mui-media" id="list">
					<div class="marginLeftRight">
						<img class="mui-media-object mui-pull-left" src="../../images/small.png">
						<h1>李</h1>
						<label class="gray-text">2016-12-12 下午</label>
					</div>
				</li>-->
			</ul>
		</div>
		
		
		
		
		
		<script type="text/javascript" src="../../js/jquery.1.11.1.js" ></script>
		<script type="text/javascript" src="../../js/constants.js" ></script>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript">
			mui.init({
				swipeBack: true, //启用右滑关闭功能
				beforeback: function() {
		//获得你要前往页面的webview id
					var Scanner = plus.webview.getWebviewById(plus.webview.currentWebview().webId);

					//触发前往页面的自定义事件（例：AddNew）,从而进行数据刷新
					mui.fire(Scanner, 'refreshWeather');

					//返回true，继续页面关闭逻辑

					
					if (!isNullStr(localStorage.storeListAgain)) {
						var Scanner = plus.webview.getWebviewById(localStorage.storeListAgain);
						mui.fire(Scanner, 'refresh');
					}
					return true;
				},
			});
			
			mui.plusReady(function () {
				localStorage.takeOutId = plus.webview.currentWebview().id;
//			    plus.nativeUI.showWaiting();
//				localStorage.registrationIndexWebId = plus.webview.currentWebview().id;

				window.addEventListener('refresh', function() {
					plus.navigator.setStatusBarBackground('#FF692C');

					// 获取所有Webview窗口
					var curr = plus.webview.currentWebview();
					var curr2 = plus.webview.getWebviewById(localStorage.homeWebId);
					var wvs = plus.webview.all();
					for(var i = 0, len = wvs.length; i < len; i++) {
						//关闭除setting页面外的其他页面
						if(wvs[i].getURL() == curr.getURL() || wvs[i].getURL() == curr2.getURL())
							continue;
						plus.webview.close(wvs[i]);
					}

				});
				plus.navigator.setStatusBarBackground('#FF692C');
				document.getElementById('zz-h5-address').innerHTML = '送至：'+localStorage.community_user_address;
				console.log('hahahhahahhahaha');
				getListData();
				var ulHeight = document.getElementById("zz-h5-address");
				
				document.getElementById("zz-div-address").setAttribute("style","height:" +ulHeight.offsetHeight+"px;")
				
				console.log(document.getElementById("zz-div-address").offsetHeight); 
				var ulMarginTop = document.getElementById("zz-div-address").offsetHeight+15;
				document.getElementById("list_already").setAttribute("style","margin-top:"+ulMarginTop +"px;");
			});
			
			function getListData() {
				postData = {};
				postData['lng'] = localStorage.lng;
				postData['lat'] = localStorage.lat;
				console.log('纬度.lat:    '+localStorage.lat);//纬度
				console.log('经度.lng:    '+localStorage.lng);//经度
				plus.nativeUI.showWaiting();
					mui.ajax({
						type: 'POST',
						url: SERVERURL + "SStoreShopInfo/getStoreShopInfo",
						data:postData,
						dataType: "json",
						timeout:20000,
						//成功获取数据赋值
						success: function(data) {
							plus.nativeUI.closeWaiting();
							var doc = document;
							fragment = doc.createDocumentFragment();
							container_already = doc.getElementById("list_already");
							mui.each(data.data, function(i) {
//								console.log('11111111111111');
								var doc = document;
								li = doc.createElement("li");
								div = doc.createElement("div");
								g_input = doc.createElement("input");
								img = doc.createElement("img");
								h3 = doc.createElement("h1");
								h3.setAttribute("style", "margin-left: 60px;");
								h3_status = doc.createElement("h3");
								h3_status.setAttribute("style", "margin-left: 60px; color: red; display: none;");
								h3Distance = doc.createElement("h3");  
								h3Distance.setAttribute("style", "margin-left: 60px;");
								li.setAttribute("class", "mui-table-view-cell mui-media ");
								li.id = data.data[i].store_shop_id;
								console.log(li.id); 
								div.setAttribute("class", "marginLeftRight ");
								img.setAttribute("class", "mui-pull-left");
								img.setAttribute("style", "width: 50px; height: 50px;");
								img.setAttribute("src", data.data[i].store_shop_picture); 
//								console.log(data.data[i].store_shop_picture);
								h3.innerHTML = data.data[i].store_shop_name;
								if(data.data[i].store_business_state == '停止营业'){
									h3_status.innerHTML = '停止营业';
									h3_status.style.display = ''; 
								}
									
								
								h3Distance.setAttribute("class", "gray-text");
								console.log(data.data[i].distance);
//								localStorage.store_carriage = data.data[i].store_carriage;
								if(parseInt(data.data[i].distance) < 1){
									h3Distance.innerHTML = "距离"+data.data[i].distance*1000+"米，"+data.data[i].store_up_to_send_price+"元起送";
									console.log('6666666666');
								}else{
									h3Distance.innerHTML = "距离"+data.data[i].distance.toFixed(1)+"千米，"+data.data[i].store_up_to_send_price+"元起送";
								}
								
 
								li.addEventListener('tap', function() {
									localStorage.shopData = JSON.stringify(data.data[i]);
									console.log("pppppppppppppppppppppppppp"+JSON.stringify(localStorage.shopData));
									var sssss = JSON.parse(localStorage.shopData);
									console.log("rrrrrrrrrrrrrrrrrrrrrrrrrr"+sssss.store_contact_user_phone);
//									console.log(localStorage.store_up_to_send_price);
//									console.log("aaaaaaaaaaa");
									mui.openWindow({
										url:'../takeOut/store.html',
										extras: {
											'store_shop_name':data.data[i].store_shop_name,
											'distance':data.data[i].distance,
											'store_carriage':data.data[i].store_carriage,
											'store_shop_picture':data.data[i].store_shop_picture,
											'store_shop_address':data.data[i].store_shop_address,
											'store_shop_id':data.data[i].store_shop_id,
											'store_up_to_send_price':data.data[i].store_up_to_send_price,
											'store_business_state':data.data[i].store_business_state,
										}
								
									});
								});
								li.appendChild(div);
								div.appendChild(img);
								div.appendChild(h3);
								div.appendChild(h3_status);
								div.appendChild(h3Distance);
								fragment.appendChild(li);
							});
							container_already.appendChild(fragment);
						},
						error: function(xhr, type, errorThrown) {
							plus.nativeUI.closeWaiting();
							console.log(type);
							mui.toast('网络连接失败');
						}
					});
				}
			var btn = document.getElementById("historyList");
			btn.addEventListener("tap", function() {
				mui.openWindow({
					url:'../takeOut/takeOutHistoryList.html',
				});
			});
			
		</script>
	</body>

</html>